# Практическое занятие
## Изучение CI/CD

## Часть 2 Continius Delivery (CD)

## Цели

- Объяснить процесс деплоя
- Дать практические задания для закрепления знаний.

## Цели методички

- ...
- Объяснить ...
- Дать практические задания для закрепления знаний.

## Структура проекта (корневая)

- `main.py` — основное FastAPI приложение
- `shop.json` — данные товаров
- `.github/workflows/ci.yml` — минимальный CI workflow
- 


## Деплой на Railway

Railway — это платформа для деплоя приложений прямо с GitHub (простой и бесплатный вариант для учебных проектов).

### Шаг 0: Добавить Procfile (важно!)

Создайте файл `Procfile` в корне репозитория (без расширения):

```
web: uvicorn main:app --host 0.0.0.0 --port $PORT
```

Это говорит Railway, как запустить приложение $PORT — переменная окружения, которую Railway выделяет вашему приложению).

### Шаг 1: Создать аккаунт на Railway

1. Перейдите на [railway.app](https://railway.app)
2. Нажмите `Start New Project`
3. Выберите `Deploy from GitHub Repo`
4. Авторизуйте GitHub (дайте Railway доступ к вашим репозиториям)

### Шаг 2: Выбрать репозиторий и ветку

1. Выберите свой репозиторий `name_repo`
2. Выберите ветку `main`
3. Railway автоматически обнаружит что это Python проект

### Шаг 3: Добавить requirements.txt (важно!)

Railway нужно знать, какие зависимости установить. Создайте файл `requirements.txt` в корне:

```
fastapi==0.109.0
uvicorn==0.27.0
pydantic==2.6.0
```

### Шаг 4: Добавить переменные окружения (опционально)

На странице проекта в Railway:

- Нажмите `Variables`
- Добавьте переменные (если нужны, например для логирования)

### Шаг 5: Дождитесь деплоя

1. Railway автоматически запустит деплой
2. Включит ваше приложение на публичный URL
3. Вы увидите что-то вроде: `https://your-app-xxxx.railway.app`

### Проверка

После деплоя приложение будет доступно по URL:

```
https://your-app-xxxx.railway.app/health
```

А документация (Swagger UI):

```
https://your-app-xxxx.railway.app/docs
```

### Автоматический деплой

После первого деплоя: каждый пуш в `main` автоматически обновит приложение на Railway!

### Альтернатива: GitHub Actions для деплоя на Railway (опционально)

Если хотите больше контроля, добавьте workflow файл `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Railway

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: railwayapp/deploy-action@v1
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

Для этого нужно:

1. На Railway: Settings → Tokens → создать новый токен
2. На GitHub добавить токен как Secret:
   - Откройте ваш репозиторий на GitHub
   - Нажмите на вкладку `Settings` (верхнее меню в репозитории)
   - В левой колонке выберите `Secrets and variables` → `Actions`
   - Нажмите `New repository secret`
   - Название: `RAILWAY_TOKEN`
   - Значение: вставьте токен с Railway
   - Нажмите `Add secret`
3. Пушить в `main` — деплой произойдёт автоматически

---

## Возможные проблемы и решения

### Проблема: `pydantic-core` не компилируется на Railway (Python 3.13)

**Ошибка:** `Failed building wheel for pydantic-core`

**Причина:** старые версии Pydantic (< 2.6) содержат Rust компоненты, которые требуют компиляции на Railway.

**Решение:** обновить `requirements.txt` на совместимые версии:

```
fastapi==0.110.0
uvicorn==0.28.0
pydantic==2.8.0
```

Эти версии имеют **предкомпилированные wheels** для Python 3.13 и устанавливаются быстро без ошибок.

**Альтернатива:** если компиляция всё ещё происходит, установите **только pre-built wheels**:

```bash
pip install --only-binary :all: -r requirements.txt
```

---

## Практические задания (рекомендуется)

1. Добавьте тесты с помощью `pytest` для проверки работы API endpoints.
2. Подключите линтер `ruff` или `flake8` и добавьте проверку в CI.

---

добавьте дополнительные эндпоинты в проект. После добавления каждого эндпоинта запускайте ci-cd

- `GET /cart` — просмотр корзины (items + total)
- `POST /cart/add?pid={id}&qty={n}` — добавить в корзину
- `DELETE /cart` — очистить корзину
- `POST /checkout` — оформить заказ (из текущей корзины)
- `GET /orders` — список заказов
- `GET /health` — проверка состояния приложения

## Советы и замечания

- В текущем учебном проекте корзина и заказы хранятся в памяти — данные теряются при перезапуске.
- Для продакшена используйте базу данных и хранение секретов через `GH Secrets` или переменные окружения.
- ID товаров — индекс в `shop.json` (начинается с 0).

---

3. Перенесите хранение корзины в файл или простую базу данных (например SQLite).
4. Добавьте логирование в приложение.

Если хотите, я могу расширить методичку: добавить раздел с примерами тестов (`pytest`), `requirements.txt`, и дополнить CI шагами для тестов и линтинга.

### Как это происходит (кратко)

- **Триггер:** пуш в ветку `main` или открытие/обновление Pull Request в `main` запускает workflow.
- **Шаги в CI:**
  - `actions/checkout` — получает код репозитория.
  - `actions/setup-python` — устанавливает Python 3.13.
  - Установка зависимостей через `pip` (FastAPI, Pydantic, Uvicorn).
  - `python -m py_compile main.py` — быстрая проверка синтаксиса.
  - `python -c "import main"` — пробный импорт модуля, чтобы убедиться, что импорт не падает.
- **Где смотреть результаты:** Зайди в вкладку `Actions` на GitHub, выбери workflow `CI` и открой последний запуск — там логи по каждому шагу.
- **Артефакты:** В минимальном варианте артефактов нет; можно добавить шаги для сохранения логов/результатов тестов при необходимости.
- **Локальная проверка:** перед пушем можно выполнить те же команды локально:

```bash
python -m pip install --upgrade pip
pip install fastapi pydantic uvicorn
python -m py_compile main.py
python -c "import main; print('imported OK')"
```

- **Советы по улучшению:** добавить `requirements.txt`, линтер (`flake8`, `ruff`) и тесты (`pytest`) в workflow для более строгой проверки.
